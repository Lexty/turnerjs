<!DOCTYPE html>
<html>
<head>
    <title>Bootstrap Specs Runner</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=9,chrome=1">
    <!-- Testing Facilities -->
    <!--<link href="../framework/jasmine-min.css" rel="stylesheet">-->

    <!--<script type="text/javascript" src="/files/js/TesticleReporter.js"></script>-->

    <script type="text/javascript">
        window.W = window.W || {};
        window.W.isUnitTestMode = true;

        if(window.top.HB){
            window.__loadTesticleReporter = function(){
                if(window.jasmine){
                    var scriptElement = document.createElement("script");
                    scriptElement.setAttribute("type", "text/javascript");
                    scriptElement.setAttribute("src", "/files/js/TesticleReporter.js");
                    document.getElementsByTagName("head")[0].appendChild(scriptElement);
                } else {
                    window.setTimeout(window.__loadTesticleReporter, 10);
                }
            };

            window.__loadTesticleReporter();
        }

        var viewMode = 'editor';

        var editorModel = {
            'mode': 'unit_test',
            metaSiteId:'mockMetaSiteId',
            editorSessionId:'mockSessionId',
            runningExperiments:{
                windowOnError:'new'
            }
        };
        var rendererModel = {
            'mode': 'unit_test',
            runningExperiments:{
                windowOnError:'new'
            }
        };
        if (window.top.HB) {
            window.editorModel.runningExperiments = window.top.HB.runningExperiments;
        } else{
            //this functionality is done in the server when not in tests
            setExperimentsFromQuery();
        }
        function setExperimentsFromQuery(){
            var query = window.location.search.replace('?', '');
            var params = query.split('&');
            for(var i =0; i< params.length; i++){
                var paramKeyValue = params[i].split('=');
                if(paramKeyValue[0].toLowerCase() == 'experiment'){
                    var expNameGroup = paramKeyValue[1].split(':');
                    window.editorModel.runningExperiments[expNameGroup[0]]  = expNameGroup[1] || 'New';
                }
            }
        }
        // Mock serviceTopology global
        serviceTopology = {
            blobUrl: "//static.wixstatic.com/",
            biServerUrl:"http://frog.wixpress.com/",
            scriptsLocationMap:{
                "bootstrap": window.top.HB ? "../../../src/main" : "/bootstrap",
                "mock": '../mock',
                "html-test-framework": window.top.HB ? "../../../../html-test-framework/src/main" : "/html-test-framework",
                "plugins": '../mock/scriptloader'
            },
            staticServerUrl : "//static.wixstatic.com/"
        };
        function clearPlayGround() {
            $('testPlayGround').empty();
        }
        function getPlayGround() {
            return $('testPlayGround');
        }


        var refresh;
        setInterval(function () {
            if (refresh && refresh.checked) {
                window.location.reload();
            }
        }, 3000);

        var onload = function () {
            var hashFlag = "AutoRefresh";
            refresh = document.getElementById("refresh");
            refresh.checked = window.location.hash.indexOf(hashFlag) > -1;
            refresh.addEventListener && refresh.addEventListener('change', function () {
                if (refresh.checked && window.location.hash.indexOf(hashFlag) === -1) {
                    window.location.hash += hashFlag;
                }
                if (!refresh.checked) {
                    window.location.hash = window.location.hash.replace(hashFlag, '');
                }
            });
        };

        function loadScript(url, callback) {

            var script = document.createElement("script")
            script.type = "text/javascript";

            if (script.readyState) { //IE
                script.onreadystatechange = function () {
                    if (script.readyState == "loaded" ||
                            script.readyState == "complete") {
                        script.onreadystatechange = null;
                        callback();
                    }
                };
            } else { //Others
                script.onload = function () {
                    callback();
                };
            }

            script.src = url;
            document.getElementsByTagName("head")[0].appendChild(script);
        }

        function loadScriptsOrder(base, urls, callback) {
            function next() {
                if(urls.length === 0){
                    return callback();
                }
                loadScript(base+urls.shift(), next);

            }
            next();
        }


    </script>
</head>
<body class="selectableChildren" onload="onload()">
<div id="testPlayGround" style="width:1px; height:1px; overflow:hidden; position:relative;"></div>


<script type="text/javascript">
    scripts = [
        "es5-shim-sham.js",
        "classList.js",
        "../../../deployment/loadInitialScriptsDynamically.js",
        "InitialStatemapOrTopologyHandler.js",
        "isExperimentOpen.js",
        "WConsole.js",
        "utils/JsExtentions.js",
        "utils/NsUtil.js",

        "define/Define.js",
        "define/DeployDefine.js",
        "define/Namespaces.js",

        "bi/Analytics.js",
        "bi/LogMessages.js",
        "bi/WixBI.js",
        "bi/Logger.js",
        "bi/biBootstrap.js",

        "windowOnError.js",

        "resource/ResourceWrapper.js",
        "resource/Resource.js",
        "resource/DeployResource.js",

        "deploy/const.Phases.js",
        "deploy/DeploymentDefinition.js",
        "deploy/DeploymentPhaseExecutor.js",
        "deploy/Deploy.js",

        "scriptloader/ManifestContext.js",
        "scriptloader/ScriptLoaderPlugin.js",
        "utils/fnvHash.js",
        "scriptloader/WixBlob.js",

        "scriptloader/ScriptLoader.js",
        "scriptloader/DeployScriptLoader.js",
        "scriptloader/Plugins.js",

        "utils/BrowserUtils.js",
        "utils/ExperimentsList.js",
        "utils/ArtifactLocationMap.js"

    ];

    var base = window.top.HB ? "../../../src/main/javascript/bootstrap/bootstrap/" : "/bootstrap/javascript/bootstrap/bootstrap/";

    loadScriptsOrder(base, scripts, function(){


        define.resource('mode', {
            debug:true,
            test:true
        });

        define.resource('tags', getTags());
        function getTags(){
            var tags = ['common', 'test'];
            var experiments = editorModel.runningExperiments;
            for(var expName in experiments){
                tags.push(expName.toLowerCase() + ':' + experiments[expName].toLowerCase());
            }
            return tags;
        }

        getIndexTopology({
                    debug:true
                }, {
                    exclude:{
                        "mock":true,
                        "plugins":true
                    }
                },
            function(ArtifactLocationMap){
            ArtifactLocationMap.all['mock'] = '../mock/';
            define.resource('topology', ArtifactLocationMap.all);
            define.resource('manifestsUrls', ArtifactLocationMap.manifestsUrls);
        });

        function loadAllIndexes(scriptLoader, manifestsUrls , callback) {
            manifestsUrls.unshift('../../../src/test/index.debug.json');
            var loaded = 0;
            manifestsUrls.forEach(function(url){
                scriptLoader.loadManifestFromUrl(url, function(){
                    loaded++;
                    if(loaded === manifestsUrls.length) {
                        callback.apply(this, arguments);
                    }
                });
            });
        }

        resource.getResources(['scriptLoader', 'manifestsUrls'], function (resources) {
            loadAllIndexes(resources.scriptLoader, resources.manifestsUrls, function() {
                define.resource('deployment', define.createBootstrapClassInstance('bootstrap.bootstrap.deploy.Deploy').init(window));
            });
        });
    });
</script>

<form>
    <label><input type="checkbox" id="refresh" checked="checked">Auto refresh</label>
</form>
</body>
</html>



