<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="x-ua-compatible" content="IE=edge" >

    <title></title>
    <style>
        html{
            overflow: hidden;
        }
        body{
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>

<div id="container"></div>

<script id="twitter-wjs" type="text/javascript" src="https://platform.twitter.com/widgets.js"></script>
<script type="text/javascript">

    /**
     * documentation https://dev.twitter.com/docs/tfw-javascript
     */

    var crutches = function(){
        if (!Function.prototype.bind) {
            Function.prototype.bind = function (oThis) {
                if (typeof this !== "function") {
                    // closest thing possible to the ECMAScript 5 internal IsCallable function
                    throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");
                }

                var aArgs = Array.prototype.slice.call(arguments, 1),
                        fToBind = this,
                        fNOP = function () {},
                        fBound = function () {
                            return fToBind.apply(this instanceof fNOP && oThis
                                    ? this
                                    : oThis,
                                    aArgs.concat(Array.prototype.slice.call(arguments)));
                        };

                fNOP.prototype = this.prototype;
                fBound.prototype = new fNOP();

                return fBound;
            };
        }

        if (!window.addEventListener){
            (function (WindowPrototype, DocumentPrototype, ElementPrototype, addEventListener, removeEventListener, dispatchEvent, registry) {
                WindowPrototype[addEventListener] = DocumentPrototype[addEventListener] = ElementPrototype[addEventListener] = function (type, listener) {
                    var target = this;

                    registry.unshift([target, type, listener, function (event) {
                        event.currentTarget = target;
                        event.preventDefault = function () { event.returnValue = false };
                        event.stopPropagation = function () { event.cancelBubble = true };
                        event.target = event.srcElement || target;

                        listener.call(target, event);
                    }]);

                    this.attachEvent("on" + type, registry[0][3]);
                };

                WindowPrototype[removeEventListener] = DocumentPrototype[removeEventListener] = ElementPrototype[removeEventListener] = function (type, listener) {
                    for (var index = 0, register; register = registry[index]; ++index) {
                        if (register[0] == this && register[1] == type && register[2] == listener) {
                            return this.detachEvent("on" + type, registry.splice(index, 1)[0][3]);
                        }
                    }
                };

                WindowPrototype[dispatchEvent] = DocumentPrototype[dispatchEvent] = ElementPrototype[dispatchEvent] = function (eventObject) {
                    return this.fireEvent("on" + eventObject.type, eventObject);
                };
            })(Window.prototype, HTMLDocument.prototype, Element.prototype, "addEventListener", "removeEventListener", "dispatchEvent", []);
        }
    };

    crutches();

    var Controller = function(){
        this.container = document.getElementById('container');
        window.addEventListener('message', this._receiveMessage.bind(this), false);
    };

    Controller.prototype = {
        _clearContainer: function(){
            this.container.innerHTML = '';
        },

        _receiveMessage: function(e){
            try { // twitter also sending its Post messages
                var eData = JSON.parse(e.data);
            } catch (ex){
                return;
            }

            var action = eData.action,
                compId = eData.compId,
                data = eData.data;

            if (action === 'create'){
                this._createTimeLine(data);
            } else if (action === 'update'){
                this._updateTimeLine(data, compId);
            }
        },

        _createTimeLine: function(data){
            this.data = data;
            twttr.widgets.createTimeline(data.widgetId, this.container, null, data);
        },

        _updateTimeLine: function(data, compId){
            var i,
                dataChanged = false,
                callback;

            for (i in data){
                if (data.hasOwnProperty(i) && this.data[i] !== data[i]){
                    this.data[i] = data[i];
                    dataChanged = true;
                }
            }

            if (dataChanged){
                this._clearContainer();
                callback = this._changeCompSize.bind(this, compId);
                twttr.widgets.createTimeline(this.data.widgetId, this.container, callback, this.data);
            }
        },

        _changeCompSize: function(compId){
            this.container.firstChild.contentWindow.addEventListener('resize', this._onTwitterIframeResize.bind(this, compId), false);
        },

        _onTwitterIframeResize: function(compId, e){
            if (this.data.showRecent){
                var height = e.target.innerHeight,
                    message;

                if (height > 0){
                    message = JSON.stringify({
                        compId: compId,
                        height: height
                    });
                    window.parent.postMessage(message, "*");
                }
            }
        }
    };

    var controller = new Controller();
</script>
</body>
</html>