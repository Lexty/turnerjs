<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link rel="stylesheet" type="text/css" href="css/slicebox.css" />
    <script type="text/javascript" src="js/modernizr.custom.46884.js"></script>
</head>
<body>

    <div class="wrapper">
        <ul id="sb-slider" class="sb-slider"></ul>
        <div id="shadow" class="shadow"></div>
        <div id="nav-arrows" class="nav-arrows">
            <a href="#">Next</a>
            <a href="#">Previous</a>
        </div>
    </div>

<script src='//sslstatic.wix.com/services/js-sdk/1.17.1/js/Wix.js'></script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
<script type="text/javascript" src="js/jquery.slicebox.js"></script>

<script type="text/javascript">

    var $el = $('#sb-slider');
    var props = {};
    var items = [];
    var currentMode = {};
    var resizeUpdateImagesTimeout;
    var autoplayTimeout;

    var pyramid = (function simplePyramid(){
        var delta = 150;
        var lastW = $(window).innerWidth();
        var lastH = $(window).innerHeight();


        return {
            isOverThresholdChange: function (){
                var w = $(window).innerWidth();
                var h = $(window).innerHeight();
                var update = false;
                if(w > (lastW + delta) || w < (lastW - delta) ){
                    update = true;
                }
                if(h > (lastH + delta) || h < (lastH - delta) ){
                    update = true;
                }
                if(update){
                    lastW = w;
                    lastH = h;
                }
                return update;
            }
        };
    }());


    Wix.addEventListener(Wix.Events.EDIT_MODE_CHANGE, function(mode) {
        currentMode = mode;
        updateAutoPlay();
    });

    Wix.addEventListener(Wix.Events.PAGE_NAVIGATION_CHANGE, function() {
     //   autoplayTimeout = setTimeout(updateAutoPlay, getDelayInMS());
        updateAutoPlay();
    });

    Wix.addEventListener(Wix.Events.SETTINGS_UPDATED, function(message) {
        if(message.cmd === 'zoomClosed'){
            hideControls();
            updateAutoPlay();//autoplayTimeout = setTimeout(updateAutoPlay, getDelayInMS());
        }else{
            props = message.props || {};
            items = message.items || [];
            refreshSlider();
        }
    });

    function getDelayInMS(){
        var ms = ((+props.autoplayInterval) * 1000);
        ms = ms < 5 ? 5 : ms;
        return ms;
    }

    function updateAutoPlay(){
        var vm = Wix.Utils.getViewMode();
        if(vm === 'preview' || vm === 'site'){
            autoplayTimeout = setTimeout(startAutoPlay, getDelayInMS());
        }else{
            stopAutoPlay()
        }
    }

    function startAutoPlay(){
        clearTimeout(autoplayTimeout);
        if(props.autoplay){
            var plugin = getPlugin();
            plugin && plugin.play();
        }
    }

    function stopAutoPlay(){
        clearTimeout(autoplayTimeout);
        var plugin = getPlugin();
        //console.log('go',plugin);
        plugin && plugin._stopSlideshow();//pause();
    }

    function destroySlider(cb){
        var plugin = getPlugin();
        plugin && plugin.destroy(cb);
    }

    function getPlugin(){
        return $el.data('slicebox');
    }

    function createSliderDom(){
        var item;
        var fragment = document.createDocumentFragment();
        for(var i=0;i<items.length;i++){
            item = items[i];
            fragment.appendChild(createSingleItem(item, i))
        }
        return fragment;
    }

    function getPerfectImageSize(viewPortWidth, viewPortHeight, imageWidth, imageHeight){

        var delta = 60;

        var w = viewPortWidth;
        var h = viewPortHeight;

        var viewPortRatio = w/h;

        var iw = imageWidth;
        var ih = imageHeight;

        if(iw < w && ih < h){

            if(iw/w < ih/h){

                ih = iw / viewPortRatio;

            } else {

                iw = ih * viewPortRatio;

            }

        } else if(iw < w){

            ih = iw / viewPortRatio;

        } else if(ih < h){

            iw = ih * viewPortRatio;

        } else {

            iw = w;
            ih = h;

        }

        if(Wix.Utils.getViewMode() === 'site'){

            return {
                width: iw <<0,//(iw - (iw % delta)) << 0,
                height:ih <<0// (ih - (ih % delta)) << 0
            };

        } else {

            return {
                width: (iw - (iw % delta)) << 0,
                height:(ih - (ih % delta)) << 0
            };

        }


    }

    function createSingleItem(item, index){


        var li = document.createElement('li');

        var img = document.createElement('img');
        var div = document.createElement('div');
        var h3 = document.createElement('h3');
        var p = document.createElement('pre');

        if(props.galleryImageOnClickAction === 'zoomMode'){
            li.style.cursor = 'pointer';
            li.onclick = function(evt){
                if(props.galleryImageOnClickAction === 'zoomMode'){
                    Wix.pushState(JSON.stringify({cmd:'zoom', args:[index]}));
                    stopAutoPlay();
                    return false;
                }
                return false;
            };
        }


        var imgSize = getPerfectImageSize($('.wrapper').width(), $('.wrapper').height(), item.width, item.height);

        //img.width = item.width;
        //img.height = item.height;

        //img.src = Wix.Utils.Media.getResizedImageUrl(item.uri, item.width, item.height);
        //img.style.clip = 'rect(0,'+$('.wrapper').width()+'px, '+$('.wrapper').height()+'px, 0)'

        img.src = Wix.Utils.Media.getResizedImageUrl(item.uri, imgSize.width, imgSize.height);

        img.setAttribute('data-uri', item.uri);


        h3.textContent = item.title;//'{{TEXT}}';
        p.textContent = item.description;//.replace(/\n/gm,'</br>');

        div.className = 'sb-description';
        if(!(item.title + item.description)){
            div.className += ' hide';
        }
        if(item.linkType !== "FREE_LINK" && props.galleryImageOnClickAction === 'goToLink'){
            var uri;
            var a = document.createElement('a');
            if (item.linkType === 'DOCUMENT') {
                uri = Wix.Utils.Media.getDocumentUrl(item.uri);
            }
            if(item.linkType === 'PAGE'){
                uri = '#';
                a.onclick = function(){
                    stopAutoPlay();
                    Wix.navigateToPage(item.href.split('/').pop());
                    return false;
                }
            }
            a.href = uri || item.href;
            a.alt = item.title;
            a.target = item.target === '_self' ? '_parent' : item.target;
            a.appendChild(img);
            img = a;
        }

        if(item.title){
            div.appendChild(h3);
        }
        if(item.description){
            div.appendChild(p);
        }

        li.appendChild(img);
        li.appendChild(div);
        return li;

    }

    $('.wrapper').hover(function(e){
        if($(e.target).is('#shadow')){return}

        if(e.type === 'mouseenter'){
            if(props.autoplay){
                $('#nav-arrows').stop().show(200);
            }
            $('.sb-current .sb-description').addClass('showOpac');
        } else {
            hideControls();
        }
    });

    function hideControls(){
        if(props.autoplay){
            $('#nav-arrows').stop().hide(200);
        }
        $('.sb-current .sb-description').removeClass('showOpac');
    }

    function reCreatePluginDom(){
        $el.empty().append(createSliderDom());
    }

    function removeLoadingScreen(){
        $('body').find('#loading').remove();
    }
    function appendLoadingScreen(){
        $('body').find('#loading').remove().end().prepend('<div id="loading">Loading...</div>');
    }

    function refreshSlider(){
        destroySlider();
        appendLoadingScreen();
        reCreatePluginDom();
        startSlider();
    }

    function startSlider(){

       var $navArrows = $('#nav-arrows').hide();
       var $shadow = $('#shadow').hide();
       var ms = getDelayInMS();

        var slicebox = $el.slicebox({
            onReady : function () {
                if(!props.autoplay){
                    $navArrows.show();
                }

                $shadow.show();

                $navArrows.children(':first').off().on('click', function () {
                    slicebox.next();
                    props.autoplay && startAutoPlay();
                    return false;
                });

                $navArrows.children(':last').off().on('click', function () {
                    slicebox.previous();
                    props.autoplay && startAutoPlay();
                    return false;
                });

                removeLoadingScreen();
                if(currentMode.viewMode){

                }
                updateAutoPlay();
            },
            onresize:function(){
                clearTimeout(resizeUpdateImagesTimeout);
                resizeUpdateImagesTimeout = setTimeout(function(){
                    if(pyramid.isOverThresholdChange()){
                        refreshSlider();
                    }
                }, 2000)
            },
            orientation : 'r',
            cuboidsRandom : true,
            disperseFactor : 25,
            interval:  ms >= 0 ? (ms+1000) : 5000,
            autoplay: props.autoplay || false
        });

    }

</script>
</body>
</html>