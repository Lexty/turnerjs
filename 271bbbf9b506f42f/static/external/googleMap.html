<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <style type="text/css">
        * {
            border: none;
            margin: 0;
            padding: 0;
        }

        html {
            height: 100%
        }

        body {
            height: 100%;
            margin: 0;
            padding: 0
        }

        #map_canvas {
            height: 100%;
            width: 100%;
        }

        .gm-style-iw p {
            width: 101%;
        }
    </style>

    <script type="text/javascript">
        var lastReceivedMsg = null;
        if (String && String.prototype && !String.prototype.trim) {
            String.prototype.trim = function () {
                return this.replace(/^\s+|\s+$/gm, '');
            };
        }

        function getUrlParams() {
            var query = location.search.substring(1),
                queryPairs = query.split('&'),
                queryPair,
                i,
                params = {};

            for (i = 0; i < queryPairs.length; i++) {
                queryPair = queryPairs[i].split('=');
                params[decodeURIComponent(queryPair[0])] = decodeURIComponent(queryPair[1] || '');
            }

            return params;
        }

        function castMapParams(params) {
            params.lat = parseFloat(params.lat) || 37.7552464;
            params.long = parseFloat(params.long) || -122.4185384;
            params.showZoom = (params.showZoom === true);
            params.showStreetView = (params.showStreetView === true);
            params.showMapType = (params.showMapType === true);
            params.mapInteractive = (params.mapInteractive === true);
            params.addressInfo = (params.addressInfo || '').trim().replace(/<\/?[^>]+>/g, " ");
            params.address = (params.address || '').trim().replace(/<\/?[^>]+>/g, " ");
            return params;
        }

        function getMapParams(params) {
            var convertedParams = {
                'zoom': 14,
                'center': window.googleMapsLatLongInstance,
                'zoomControl': params.showZoom,
                'streetViewControl': params.showStreetView,
                'mapTypeControl': params.showMapType,
                'scaleControl': true,
                'draggable': params.mapInteractive,
                'disableDefaultUI': !params.mapInteractive,
                'disableDoubleClickZoom': !params.mapInteractive,
                'scrollwheel': params.mapInteractive
            };

            if (params.mapType) {
                convertedParams.mapTypeId = google.maps.MapTypeId[params.mapType];
            }

            if (params.mapStyle) {
                convertedParams.styles = JSON.parse(params.mapStyle);
            }

            return convertedParams;
        }

        function getMarkerTitle (params) {
            return params.addressInfo ? '' : 'Click to see more...';
        }

        function getInfoWindowContent(params) {
            return params.addressInfo || params.address;
        }

        function createMap(params) {
            formattedParams = getMapParams(params);
            var map = new google.maps.Map(document.getElementById("map_canvas"), formattedParams);
            return map;
        }

        function createMarker(map, title) {
            return new google.maps.Marker({
                position: window.googleMapsLatLongInstance,
                map: map,
                title: title
            });
        }

        function createLatLong(lat, long) {
            return new google.maps.LatLng(lat, long);
        }

        function createInfoWindow(content) {
            return new google.maps.InfoWindow({
                maxWidth: (window.innerWidth ? window.innerWidth : document.documentElement.clientWidth) * .7, // fix for autoPan bug
                content: content
            })
        }

        function updateMap(msg) {
            if (!msg || !window.googleMapsInstance) {
                return;
            }

            var parsedParams = JSON.parse(msg.data);
            window.googleMapsLatLongInstance = createLatLong(parsedParams.lat, parsedParams.long);

            var formattedParams = getMapParams(parsedParams);
            window.googleMapsInstance.setOptions(formattedParams);
            window.googleMapsMarkerInstance.setOptions({position: window.googleMapsLatLongInstance, title: getMarkerTitle(parsedParams)});
            window.googleMapsInfoWindowInstance.setOptions({position: window.googleMapsLatLongInstance, content: getInfoWindowContent(parsedParams)});
        }

        function bindEvents(map, marker, infoWindow) {
            google.maps.event.addListener(marker, 'click', function () {
                marker.setTitle("");
                infoWindow.open(map, marker);
            });

            google.maps.event.addListener(infoWindow, 'closeclick', function () {
                marker.setTitle("Click to see more...");
                map.setCenter(window.googleMapsLatLongInstance);
            });

            //spike for google maps known bug https://code.google.com/p/gmaps-api-issues/issues/detail?id=5713
            google.maps.event.addListenerOnce(map, 'idle', function () {
                setTimeout(function () {
                    marker.setTitle("");
                    infoWindow.open(map, marker);
                }, 100);
            });
        }

        function loadScript(language, callback){
            var scriptNode = document.createElement('script');
            scriptNode.type = "text/javascript";
            scriptNode.src = "//maps.googleapis.com/maps/api/js?client=gme-wixcomltd2&callback=initMap&language=" + language;

            document.body.appendChild(scriptNode);
        }

        function initMap(){
            var parsedMsg;
            try {
                parsedMsg = JSON.parse(lastReceivedMsg.data);
            } catch (e) {
                parsedMsg = {};
            }
            var parsedParams = castMapParams(parsedMsg);

            window.googleMapsLatLongInstance = createLatLong(parsedParams.lat, parsedParams.long);
            window.googleMapsInstance = createMap(parsedParams);
            window.googleMapsMarkerInstance = createMarker(window.googleMapsInstance, getMarkerTitle(parsedParams));
            window.googleMapsInfoWindowInstance = createInfoWindow(getInfoWindowContent(parsedParams));
            bindEvents(window.googleMapsInstance, window.googleMapsMarkerInstance, window.googleMapsInfoWindowInstance);
        }

        function saveMsgAndUpdateMap(msg) {
            lastReceivedMsg = msg;
            updateMap(msg);
        }

        function initialize() {
            window.addEventListener('message', saveMsgAndUpdateMap, false);
            loadScript(getUrlParams().language);
        }

    </script>
</head>
<body onload="initialize()">
<div id="map_canvas"></div>
</body>
</html>
